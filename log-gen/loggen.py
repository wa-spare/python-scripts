import os, json, time, re, datetime, random
from json import JSONEncoder
row_num=0
file_dttm=str(datetime.datetime.now())
file_dttm= file_dttm.replace(":","_")
file_dttm= file_dttm.replace(" ","T")
log_file=os.getcwd() + '\\newlog-' + f'{file_dttm}' + 'Z.log.json'
print(f'writing logs to: {log_file}')

while True:
  timenow = datetime.datetime.now()
  row_num +=1
  fmt_num = '{:0>6}'.format(row_num)
  rand_str = str(random.randint(1000000000,9999999999))
  soc_sec = rand_str[:3] + '-' + rand_str[3:5] + '-' + rand_str[6:]
  #print(f'soc sec #: {soc_sec}')
  payload = '{"@t":"' \
    + f'{timenow}' \
    + '","row_num":"' \
    + f'{fmt_num}' \
    + '","test_dttm":"' \
    + f'{file_dttm}' \
    + '","soc_sec":"' \
    + f'{soc_sec}' \
    + '","@l":"Error","@x":"StackExchange.Redis.RedisConnectionException: No connection is active/available to service this operation: XLEN IncomingMailboxEvents:382; SocketClosed (ReadEndOfStream, last-recv: 0) on redis-14791.redis-dev.shared360dev.com:14791/Subscription, Idle/MarkProcessed, last: PING, origin: ReadFromPipe, outstanding: 0, last-read: 0s ago, last-write: 1s ago, keep-alive: 60s, state: ConnectedEstablished, mgr: 8 of 10 available, in: 0, in-pipe: 0, out-pipe: 0, last-heartbeat: 0s ago, last-mbeat: 0s ago, global: 0s ago, v: 2.2.62.27853, mc: 1/1/0, mgr: 10 of 10 available, clientName: DC1T1AP-D002ASF, IOCP: (Busy=0,Free=1000,Min=2,Max=1000), WORKER: (Busy=1,Free=32766,Min=2,Max=32767), Local-CPU: 0%, v: 2.2.62.27853 ---> StackExchange.Redis.RedisConnectionException: SocketClosed (ReadEndOfStream, last-recv: 0) on redis-14791.redis-dev.shared360dev.com:14791/Subscription, Idle/MarkProcessed, last: PING, origin: ReadFromPipe, outstanding: 0, last-read: 0s ago, last-write: 1s ago, keep-alive: 60s, state: ConnectedEstablished, mgr: 8 of 10 available, in: 0, in-pipe: 0, out-pipe: 0, last-heartbeat: 0s ago, last-mbeat: 0s ago, global: 0s ago, v: 2.2.62.27853\r\n   --- End of inner exception stack trace ---\r\n   at StackExchange.Redis.ConnectionMultiplexer.ThrowFailed[T](TaskCompletionSource`1 source, Exception unthrownException) in /_/src/StackExchange.Redis/ConnectionMultiplexer.cs:line 2794\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at CESS.MailboxQueueSync.ToMailboxQueueProducer.<SynchronizeAsync>d__4.MoveNext() in e:\\jenkins\\workspace\\HCRM-Cess\\CFN.CRM.CESS2.Fabric\\build\\CFN.CRM.CESS2.Fabric\\CESS.QueueSync\\Mailbox\\ToMailboxQueueProducer.cs:line 31\r\n--- End of stack trace from previous location where exception was thrown ---\r\n   at System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw()\r\n   at System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification(Task task)\r\n   at CESS.ExchangeToQueuePollPub.PollUsersToMailboxQueueService.<PollUsersAndPushMailboxNotificationsAsync>d__5.MoveNext() in e:\\jenkins\\workspace\\HCRM-Cess\\CFN.CRM.CESS2.Fabric\\build\\CESS.Core\\CESS.Polling\\ExchangeToQueuePolling\\PollUsersToMailboxQueueService.cs:line 55","SourceContext":"CESS.ExchangeToQueuePollPub.PollUsersToMailboxQueueService","ExceptionDetail":{"Data":{"Redis-Multiplexer-Connects":"1/1/0","Redis-Manager":"10 of 10 available","Redis-Client-Name":"DC1T1AP-D002ASF","Redis-ThreadPool-IO-Completion":"(Busy=0,Free=1000,Min=2,Max=1000)","Redis-ThreadPool-Workers":"(Busy=1,Free=32766,Min=2,Max=32767)","Redis-Busy-Workers":"1","Redis-Local-CPU":"0%","Redis-Version":"2.2.62.27853","redis-command":"XLEN IncomingMailboxEvents:382","request-sent-status":"WaitingToBeSent"},"HResult":-2146233088,"Message":"No connection is active/available to service this operation: XLEN IncomingMailboxEvents:382; SocketClosed (ReadEndOfStream, last-recv: 0) on redis-14791.redis-dev.shared360dev.com:14791/Subscription, Idle/MarkProcessed, last: PING, origin: ReadFromPipe, outstanding: 0, last-read: 0s ago, last-write: 1s ago, keep-alive: 60s, state: ConnectedEstablished, mgr: 8 of 10 available, in: 0, in-pipe: 0, out-pipe: 0, last-heartbeat: 0s ago, last-mbeat: 0s ago, global: 0s ago, v: 2.2.62.27853, mc: 1/1/0, mgr: 10 of 10 available, clientName: DC1T1AP-D002ASF, IOCP: (Busy=0,Free=1000,Min=2,Max=1000), WORKER: (Busy=1,Free=32766,Min=2,Max=32767), Local-CPU: 0%, v: 2.2.62.27853","Source":"StackExchange.Redis","InnerException":{"Data":{"Redis-FailureType":"SocketClosed","Redis-EndPoint":"redis-14791.redis-dev.shared360dev.com:14791","Redis-Origin":"ReadFromPipe","Redis-Outstanding-Responses":"0","Redis-Last-Read":"0s ago","Redis-Last-Write":"1s ago","Redis-Keep-Alive":"60s","Redis-Previous-Physical-State":"ConnectedEstablished","Redis-Manager":"8 of 10 available","Redis-Inbound-Bytes":"0","Redis-Inbound-Pipe-Bytes":"0","Redis-Outbound-Pipe-Bytes":"0","Redis-Last-Heartbeat":"0s ago","Redis-Last-Multiplexer-Heartbeat":"0s ago","Redis-Last-Global-Heartbeat":"0s ago","Redis-Version":"2.2.62.27853"},"HResult":-2146233088,"Message":"SocketClosed (ReadEndOfStream, last-recv: 0) on redis-14791.redis-dev.shared360dev.com:14791/Subscription, Idle/MarkProcessed, last: PING, origin: ReadFromPipe, outstanding: 0, last-read: 0s ago, last-write: 1s ago, keep-alive: 60s, state: ConnectedEstablished, mgr: 8 of 10 available, in: 0, in-pipe: 0, out-pipe: 0, last-heartbeat: 0s ago, last-mbeat: 0s ago, global: 0s ago, v: 2.2.62.27853","Source":null,"FailureType":"SocketClosed","CommandStatus":"Unknown","Type":"StackExchange.Redis.RedisConnectionException"},"FailureType":"UnableToResolvePhysicalConnection","CommandStatus":"WaitingToBeSent","Type":"StackExchange.Redis.RedisConnectionException"},"MachineName":"DC1T1AP-D002ASF","ApplicationName":"CESS2","TeamName":"HCRM"}'
 #--Use either row 25 above for larger payload or use this row for smaller--#    + '","level":"info","source":"wwa-loggen.py","description":"Performance Degradation Found in CrAppD","eventType":"CUSTOM_INFO","start":"end"}'
  print(f'{payload}')
  with open(log_file, 'a')  as outputFile:  
    outputFile.write(f'{payload}' + '\n')
  time.sleep(2.5)
